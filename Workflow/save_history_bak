#!/usr/bin/osascript -l JavaScript

// Helpers
// Helpers
function envVar(varName) {
  return $.NSProcessInfo
    .processInfo
    .environment
    .objectForKey(varName).js
}

function makeDir(path) {
  $.NSFileManager.defaultManager.createDirectoryAtPathWithIntermediateDirectoriesAttributesError(
    path, true, undefined, undefined)
}

function writeFile(path, text) {
  $(text).writeToFileAtomicallyEncodingError(path, true, $.NSUTF8StringEncoding, undefined)
}

function mv(initPath, targetPath) {
  $.NSFileManager.defaultManager.moveItemAtPathToPathError(initPath, targetPath, undefined)
}

function copyFile(initPath, targetPath) {
  $.NSFileManager.defaultManager.copyItemAtPathToPathError(initPath, targetPath, undefined)
}

function padDate(number) {
  return number.toString().padStart(2, "0")
}

// Main
function run(argv) {
  // Constants for archive file name
  const uid = $.NSProcessInfo.processInfo.globallyUniqueString.js.split("-")[0]
  const currentDate = new Date()
  const currentYear = currentDate.getFullYear()
  const currentMonth = padDate(currentDate.getMonth() + 1) // Months are zero-based
  const currentDay = padDate(currentDate.getDate())
  const currentHour = padDate(currentDate.getHours())
  const currentMinute = padDate(currentDate.getMinutes())
  const currentSecond = padDate(currentDate.getSeconds())

  // Main
  const currentChat = `${envVar("alfred_workflow_data")}/chat.json`
  const replacementChat = envVar("replace_with_chat")
  const archiveDir = `${envVar("alfred_workflow_data")}/archive`
  const archivedChat = `${archiveDir}/${currentYear}.${currentMonth}.${currentDay}.${currentHour}.${currentMinute}.${currentSecond}-${uid}.json`
  const userSaveDir = envVar("chat_history_save_dir") // 用户指定的保存目录

  makeDir(archiveDir)
  mv(currentChat, archivedChat)

  // 如果用户设置了保存目录，则额外复制一份到用户指定目录
  if (userSaveDir && userSaveDir.length > 0) {
    makeDir(userSaveDir)
    const userArchivedChat = `${userSaveDir}/${currentYear}.${currentMonth}.${currentDay}.${currentHour}.${currentMinute}.${currentSecond}-${uid}.json`
    copyFile(archivedChat, userArchivedChat)
  }

  if (replacementChat) {
    mv(replacementChat, currentChat)
  } else {
    writeFile(currentChat, "[]")
  }
}